pipeline {
    agent any

    environment {
        BACKEND_IMAGE = "janithdev/kudos-craft-backend"
        FRONTEND_IMAGE = "janithdev/kudos-craft-frontend"
        TF_VAR_ssh_pub_key = credentials('prod-ssh-pub-key')       
        TF_VAR_do_token = credentials('digitalocean-access-token')
    }

    stages {
        stage('Checkout') {
            steps { checkout scm }
        }

        stage('Build & Push Docker Images') {
            parallel {
                stage('Frontend Image') {
                    steps {
                        dir('frontend') {
                            script {
                                def customImage = docker.build("${FRONTEND_IMAGE}:${env.BUILD_NUMBER}")
                                docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') { customImage.push() }
                            }
                        }
                    }
                }
                stage('Backend Image') {
                    steps {
                        dir('backend') {
                            script {
                                def customImage = docker.build("${BACKEND_IMAGE}:${env.BUILD_NUMBER}")
                                docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') { customImage.push() }
                            }
                        }
                    }
                }
            }
        }

        stage('Provision Infrastructure (Terraform)') {
            steps {
                script {
                    echo 'Initializing Terraform...'
                    sh 'terraform init'

                    echo 'Applying Terraform changes...'
                    sh 'terraform apply -auto-approve'

                    echo "Waiting for Droplet to boot..."
                    sleep 30 

                    // --- FIX 1: Save IP to 'env.SERVER_IP' (Global) instead of 'def serverIp' (Local) ---
                    env.SERVER_IP = sh(script: "terraform output -raw droplet_ip", returnStdout: true).trim()
                    
                    echo "Deploying to server at: ${env.SERVER_IP}"

                    // Use env.SERVER_IP here too
                    def inventoryContent = "[webserver]\n${env.SERVER_IP} ansible_user=root ansible_ssh_private_key_file=temp-key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                    writeFile file: 'inventory.ini', text: inventoryContent
                }
            }
        }

        stage('Debug SSH Connection') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'prod-ssh-key', variable: 'SSH_KEY_FILE')]) {
                        sh "cp ${SSH_KEY_FILE} debug-key.pem && chmod 600 debug-key.pem"
                        
                        echo "Testing raw SSH connection..."
                        // --- FIX 2: Use '${env.SERVER_IP}' to access the global variable ---
                        sh "ssh -v -i debug-key.pem -o StrictHostKeyChecking=no root@${env.SERVER_IP} 'echo SSH_IS_WORKING'"
                    }
                }
            }
        }

        stage('Deploy Configuration (Ansible)') {
            steps {
                script {
                    withCredentials([
                        file(credentialsId: 'prod-ssh-key', variable: 'SSH_KEY_FILE'),
                        usernamePassword(credentialsId: 'dockerhub-credentials', passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')
                    ]) {
                        
                        echo "Using key file: ${SSH_KEY_FILE}"
                        sh "cp ${SSH_KEY_FILE} temp-key.pem"
                        sh "chmod 600 temp-key.pem"

                        try {
                            echo 'Executing playbook...'
                            // --- FIX 3: Changed '-u ubuntu' to '-u root' ---
                            // DigitalOcean droplets default to 'root'. Using 'ubuntu' will cause Permission Denied.
                            sh '''
                                ansible-playbook playbook.yml \
                                -i inventory.ini \
                                -u root \
                                --private-key=temp-key.pem \
                                --ssh-common-args="-o StrictHostKeyChecking=no -o IdentitiesOnly=yes" \
                                -e "build_number=${BUILD_NUMBER}" \
                                -e "docker_password=${DOCKER_PASS}" \
                                -e "docker_user=${DOCKER_USER}"
                                '''
                        } finally {
                            sh "rm -f temp-key.pem"
                        }
                    }
                }
            }
        }
    }
}