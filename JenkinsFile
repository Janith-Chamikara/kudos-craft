pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                echo 'Getting code...'
                checkout scm
            }
        }

        stage('Parallel Builds') {
            parallel {
                // --- Job 1: Frontend ---
                stage('Frontend Build') {
                    steps {
                        dir('frontend') {
                            echo 'Installing frontend dependencies...'
                            sh 'npm install --legacy-peer-deps --timeout=600000 --fetch-timeout=600000'
                            
                            echo 'Building frontend...'
                            sh 'npm run build'
                        }
                    }
                }
                
                // --- Job 2: Backend ---
                stage('Backend Build') {
                    environment {
                        DATABASE_URL = 'file:./dev.db'
                        NODE_ENV = 'development'
                    }

                    steps {
                        dir('backend') {
                            echo 'Installing backend dependencies'
                            sh 'npm install --network-timeout=1000000'

                            echo 'Running Prisma migrations'
                            sh 'npx prisma migrate deploy'

                            echo 'Generate prisam client'
                            sh 'npx prisma generate'

                            echo 'Seed the database'
                            sh 'npm run seed'
                            
                            echo 'Building backend...'
                            sh 'npm run build'
                        }
                    }
                }



            }
        }

        stage('Parallel docker builds') {

            environment {
                BACKEND_IMAGE = "janithdev/kudos-craft-backend"
                FRONTEND_IMAGE = "janithdev/kudos-craft-frontend"
            }

            parallel {
                // --- Job 3: Frontend docker image ---
                stage('Frontend docker image creation') {
                    steps {
                        dir('frontend') {
                            echo 'Creating frontend docker image...'

                            script {
                                frontendDockerImage = docker.build("${FRONTEND_IMAGE}:${env.BUILD_NUMBER}")
                            }
                        }
                    }
                }
                
                // --- Job 4: Backend docker image ---
                stage('Backend doocker image creation') {
                    environment {
                        DATABASE_URL = 'file:./dev.db'
                        NODE_ENV = 'development'
                    }

                    steps {
                        dir('backend') {
                            echo 'Creating backend docker image...'

                            script {
                                backendDockerImage = docker.build("${BACKEND_IMAGE}:${env.BUILD_NUMBER}")
                            }
                        }
                    }
                }

                

            }
        }

        // stage('Pushing frontend and backend docker images to docker hub....') {
        //     parallel {
        //         // --- Job 3: Pushing Frontend docker image ---
        //         stage('Pushing frontend docker image') {
        //             steps {
        //                 echo 'Pushing frontend docker image...'

        //                 script {
        //                     docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') 
        //                     { frontendDockerImage.push() }
        //                 }
        //             }
        //         }
                
        //         // --- Job 4: Pushing Backend docker image ---
        //         stage('Pushing backend docker image') {
        //             steps {
        //                 echo 'Pushing backend docker image...'
                        
        //                 script {
        //                     docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') 
        //                     { backendDockerImage.push() }
        //                 }     
        //             }  
        //         }
        //     }
        // }

        stage('Creating AWS infrastructure...') {
            steps {
                echo 'Initializing Terraform...'
                sh 'terraform init'

                echo 'Planning Terraform changes...'
                sh 'terraform plan'

                echo 'Applying Terraform changes...'
                sh 'terraform apply -auto-approve'

                echo 'Terraform execution complete!'
            }
        }

    }
}