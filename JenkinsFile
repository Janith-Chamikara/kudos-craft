pipeline {
    agent any

    environment {
        BACKEND_IMAGE = "janithdev/kudos-craft-backend"
        FRONTEND_IMAGE = "janithdev/kudos-craft-frontend"
        TF_VAR_ssh_key_path = "~/.ssh/id_rsa.pub"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Getting code...'
                checkout scm
            }
        }

        stage('Build & Push Docker Images') {
            parallel {
                stage('Frontend Image') {
                    steps {
                        dir('frontend') {
                            script {
                                // Build
                                def customImage = docker.build("${FRONTEND_IMAGE}:${env.BUILD_NUMBER}")
                                
                                // Push (Combine build & push to keep context simple)
                                docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                                    customImage.push()
                                }
                            }
                        }
                    }
                }
                
                stage('Backend Image') {
                    steps {
                        dir('backend') {
                            script {
                                def customImage = docker.build("${BACKEND_IMAGE}:${env.BUILD_NUMBER}")
                                
                                docker.withRegistry('https://index.docker.io/v1/', 'dockerhub-credentials') {
                                    customImage.push()
                                }
                            }
                        }
                    }
                }
            }
        }

        stage('Find Keys') {
            steps {
                // List the contents of the .ssh folder to see the real path
                sh 'ls -la ~/.ssh'
                
                // Print the full path to the home directory
                sh 'echo $HOME'
            }
        }

        stage('Provision Infrastructure (Terraform)') {
            environment {
                TF_VAR_do_token = credentials('digitalocean-access-token')
            }
            steps {
                script {
                    echo 'Initializing Terraform...'
                    sh 'terraform init'

                    echo 'Applying Terraform changes...'
                    sh 'terraform apply -auto-approve'

                    def serverIp = sh(script: "terraform output -raw droplet_ip", returnStdout: true).trim()
                    echo "Deploying to server at: ${serverIp}"
                    
                    def inventoryContent = "[webserver]\n${serverIp} ansible_user=root ansible_ssh_common_args='-o StrictHostKeyChecking=no'"
                    writeFile file: 'inventory.ini', text: inventoryContent
                }
            }
        }

        stage('Deploy Configuration (Ansible)') {
            steps {
                script {
                    sh "cat inventory.ini"

                    withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', passwordVariable: 'DOCKER_PASS', usernameVariable: 'DOCKER_USER')]) {
                        echo 'Executing playbook...'
                        
                        // Pass the BUILD_NUMBER so Ansible knows which tag to pull
                        sh """
                        ansible-playbook playbook.yml \
                        -i inventory.ini \
                        -u root \
                        -e "build_number=${env.BUILD_NUMBER}" \
                        -e "docker_password=${DOCKER_PASS}" \
                        -e "docker_user=${DOCKER_USER}"
                        """
                    }
                }
            }
        }
    }
}