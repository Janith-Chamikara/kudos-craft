name: Update Dependencies

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual triggering

jobs:
  update-npm-dependencies:
    name: Update NPM Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        directory: [backend, frontend]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: ${{ matrix.directory }}/package-lock.json

      - name: Update dependencies
        working-directory: ./${{ matrix.directory }}
        run: |
          npm update
          npm audit fix --force || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update ${{ matrix.directory }} dependencies"
          title: "chore: update ${{ matrix.directory }} dependencies"
          body: |
            This PR updates the dependencies for the ${{ matrix.directory }} project.

            - Updated npm packages to latest compatible versions
            - Fixed security vulnerabilities with `npm audit fix`

            Please review the changes and test thoroughly before merging.
          branch: update-deps-${{ matrix.directory }}-${{ github.run_number }}
          base: main

  update-dotnet-dependencies:
    name: Update .NET Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0"

      - name: Update .NET packages
        working-directory: ./desktop/KudosCraft
        run: |
          dotnet list package --outdated
          dotnet add package --prerelease || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update .NET dependencies"
          title: "chore: update .NET dependencies"
          body: |
            This PR updates the dependencies for the desktop (.NET) project.

            - Updated NuGet packages to latest versions

            Please review the changes and test thoroughly before merging.
          branch: update-deps-dotnet-${{ github.run_number }}
          base: main
