#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🚀 Running pre-push checks..."

protected_branch='main'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

# Check if pushing to protected branch
if [ $protected_branch = $current_branch ]; then
    echo "🛡️  Direct push to $protected_branch branch is not allowed"
    echo "Please create a pull request instead"
    exit 1
fi

# Run security audit
echo "🔒 Running security audit..."

if [ -d "backend" ]; then
    cd backend
    npm audit --audit-level=moderate
    if [ $? -ne 0 ]; then
        echo "❌ Backend security audit failed"
        exit 1
    fi
    cd ..
fi

if [ -d "frontend" ]; then
    cd frontend
    npm audit --audit-level=moderate
    if [ $? -ne 0 ]; then
        echo "❌ Frontend security audit failed"
        exit 1
    fi
    cd ..
fi

# Check for sensitive files
echo "🔍 Checking for sensitive files..."
if git diff --cached --name-only | grep -E "\.(env|key|pem|p12|pfx)$"; then
    echo "❌ Attempting to commit sensitive files"
    exit 1
fi

# Check for TODO/FIXME in staged files
echo "📝 Checking for TODO/FIXME in staged files..."
if git diff --cached | grep -E "(TODO|FIXME|XXX)"; then
    echo "⚠️  Found TODO/FIXME comments in staged files"
    echo "Please resolve or acknowledge these before pushing"
    read -p "Continue anyway? (y/n): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

echo "✅ All pre-push checks passed!"
