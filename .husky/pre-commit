#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the backend directory
if [ -d "backend" ]; then
    echo "ğŸ“¦ Backend: Installing dependencies..."
    cd backend && npm ci
    
    echo "ğŸ”§ Backend: Running lint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ Backend lint failed"
        exit 1
    fi
    
    echo "ğŸ’„ Backend: Checking format..."
    npx prettier --check "src/**/*.ts" "test/**/*.ts"
    if [ $? -ne 0 ]; then
        echo "âŒ Backend format check failed"
        echo "Run: npm run format"
        exit 1
    fi
    
    echo "ğŸ—ï¸  Backend: Building..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Backend build failed"
        exit 1
    fi
    
    echo "ğŸ§ª Backend: Running tests..."
    npm test
    if [ $? -ne 0 ]; then
        echo "âŒ Backend tests failed"
        exit 1
    fi
    
    cd ..
fi

# Check if we're in the frontend directory
if [ -d "frontend" ]; then
    echo "ğŸ“¦ Frontend: Installing dependencies..."
    cd frontend && npm ci
    
    echo "ğŸ”§ Frontend: Running lint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "âŒ Frontend lint failed"
        exit 1
    fi
    
    echo "ğŸ’„ Frontend: Checking format..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
        echo "âŒ Frontend format check failed"
        echo "Run: npm run format"
        exit 1
    fi
    
    echo "ğŸ“ Frontend: Type checking..."
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "âŒ Frontend type check failed"
        exit 1
    fi
    
    echo "ğŸ—ï¸  Frontend: Building..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "âŒ Frontend build failed"
        exit 1
    fi
    
    cd ..
fi

# Check if we're in the desktop directory
if [ -d "desktop/KudosCraft" ]; then
    echo "ğŸ“¦ Desktop: Restoring dependencies..."
    cd desktop/KudosCraft && dotnet restore
    
    echo "ğŸ—ï¸  Desktop: Building..."
    dotnet build --configuration Release --no-restore
    if [ $? -ne 0 ]; then
        echo "âŒ Desktop build failed"
        exit 1
    fi
    
    echo "ğŸ§ª Desktop: Running tests..."
    dotnet test --configuration Release --no-build --verbosity minimal
    if [ $? -ne 0 ]; then
        echo "âŒ Desktop tests failed"
        exit 1
    fi
    
    cd ../..
fi

echo "âœ… All checks passed! Ready to commit."
