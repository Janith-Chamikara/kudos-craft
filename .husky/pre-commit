#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# Check if we're in the backend directory
if [ -d "backend" ]; then
    echo "📦 Backend: Installing dependencies..."
    cd backend && npm ci
    
    echo "🔧 Backend: Running lint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "❌ Backend lint failed"
        exit 1
    fi
    
    echo "💄 Backend: Checking format..."
    npx prettier --check "src/**/*.ts" "test/**/*.ts"
    if [ $? -ne 0 ]; then
        echo "❌ Backend format check failed"
        echo "Run: npm run format"
        exit 1
    fi
    
    echo "🏗️  Backend: Building..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "❌ Backend build failed"
        exit 1
    fi
    
    echo "🧪 Backend: Running tests..."
    npm test
    if [ $? -ne 0 ]; then
        echo "❌ Backend tests failed"
        exit 1
    fi
    
    cd ..
fi

# Check if we're in the frontend directory
if [ -d "frontend" ]; then
    echo "📦 Frontend: Installing dependencies..."
    cd frontend && npm ci
    
    echo "🔧 Frontend: Running lint..."
    npm run lint
    if [ $? -ne 0 ]; then
        echo "❌ Frontend lint failed"
        exit 1
    fi
    
    echo "💄 Frontend: Checking format..."
    npx prettier --check .
    if [ $? -ne 0 ]; then
        echo "❌ Frontend format check failed"
        echo "Run: npm run format"
        exit 1
    fi
    
    echo "📝 Frontend: Type checking..."
    npx tsc --noEmit
    if [ $? -ne 0 ]; then
        echo "❌ Frontend type check failed"
        exit 1
    fi
    
    echo "🏗️  Frontend: Building..."
    npm run build
    if [ $? -ne 0 ]; then
        echo "❌ Frontend build failed"
        exit 1
    fi
    
    cd ..
fi

# Check if we're in the desktop directory
if [ -d "desktop/KudosCraft" ]; then
    echo "📦 Desktop: Restoring dependencies..."
    cd desktop/KudosCraft && dotnet restore
    
    echo "🏗️  Desktop: Building..."
    dotnet build --configuration Release --no-restore
    if [ $? -ne 0 ]; then
        echo "❌ Desktop build failed"
        exit 1
    fi
    
    echo "🧪 Desktop: Running tests..."
    dotnet test --configuration Release --no-build --verbosity minimal
    if [ $? -ne 0 ]; then
        echo "❌ Desktop tests failed"
        exit 1
    fi
    
    cd ../..
fi

echo "✅ All checks passed! Ready to commit."
